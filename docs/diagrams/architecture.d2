# Claude UI Architecture Diagram
# Data flows DOWN: External → Main → Bridge → Renderer
# Simplified for readability

direction: down

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: dagre
  }
}

# ============================================
# LAYER 1: EXTERNAL SERVICES & HUB
# ============================================
external: External Services & Hub {
  style: {
    fill: "#1e1e30"
    stroke: "#f59e0b"
    stroke-width: 4
    border-radius: 16
    font-size: 24
  }

  hub: Hub Server + SQLite {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/fastify/fastify-original.svg
    style.fill: "#16213e"
    style.stroke: "#f59e0b"
    style.border-radius: 12
    style.font-size: 20
  }

  anthropic: Anthropic API {
    style.fill: "#16213e"
    style.stroke: "#D97706"
    style.border-radius: 12
    style.font-size: 20
  }

  github: GitHub API {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg
    style.fill: "#16213e"
    style.stroke: "#ffffff"
    style.border-radius: 12
    style.font-size: 20
  }

  integrations: Spotify / Calendar / OAuth {
    style.fill: "#16213e"
    style.stroke: "#a855f7"
    style.border-radius: 12
    style.font-size: 20
  }
}

# ============================================
# LAYER 2: MAIN PROCESS
# ============================================
main: Main Process (Electron 39 + Node.js) {
  style: {
    fill: "#1a1a2e"
    stroke: "#10b981"
    stroke-width: 4
    border-radius: 16
    font-size: 24
  }

  services: 29 Services {
    style.fill: "#16213e"
    style.stroke: "#10b981"
    style.border-radius: 12
    style.font-size: 20
  }

  ipc: IPC Router + Handlers {
    style.fill: "#16213e"
    style.stroke: "#f59e0b"
    style.border-radius: 12
    style.font-size: 20
  }

  storage: "Local: JSON, .auto-claude specs" {
    style.fill: "#16213e"
    style.stroke: "#8b5cf6"
    style.border-radius: 12
    style.font-size: 20
  }

  servers: MCP Servers / PTY {
    style.fill: "#16213e"
    style.stroke: "#ec4899"
    style.border-radius: 12
    style.font-size: 20
  }

  # Internal
  ipc -> services: Zod validate {
    style.stroke: "#10b981"
    style.stroke-width: 2
    style.stroke-dash: 4
  }
  services -> storage: read/write {
    style.stroke: "#8b5cf6"
    style.stroke-width: 2
    style.stroke-dash: 4
  }
}

# ============================================
# LAYER 3: PRELOAD BRIDGE
# ============================================
bridge: Preload Bridge {
  style: {
    fill: "#0f3460"
    stroke: "#e94560"
    stroke-width: 4
    border-radius: 16
    font-size: 24
  }

  invoke: api.invoke(channel, input) {
    style.fill: "#16213e"
    style.stroke: "#e94560"
    style.border-radius: 12
    style.font-size: 20
  }

  events: api.on(channel, handler) {
    style.fill: "#16213e"
    style.stroke: "#e94560"
    style.border-radius: 12
    style.font-size: 20
  }
}

# ============================================
# LAYER 4: RENDERER PROCESS
# ============================================
renderer: Renderer Process (React 19) {
  style: {
    fill: "#1a1a2e"
    stroke: "#4f46e5"
    stroke-width: 4
    border-radius: 16
    font-size: 24
  }

  cache: React Query Cache {
    style.fill: "#16213e"
    style.stroke: "#FF4154"
    style.border-radius: 12
    style.font-size: 20
  }

  server-state: "Server State: Projects, Tasks, Agents" {
    style.fill: "#16213e"
    style.stroke: "#FF4154"
    style.border-radius: 12
    style.font-size: 18
  }

  zustand: Zustand Stores {
    style.fill: "#16213e"
    style.stroke: "#764ABC"
    style.border-radius: 12
    style.font-size: 20
  }

  ui-state: "UI State: sidebar, theme, selections" {
    style.fill: "#16213e"
    style.stroke: "#764ABC"
    style.border-radius: 12
    style.font-size: 18
  }

  hooks: useQuery / useMutation / useIpcEvent {
    style.fill: "#16213e"
    style.stroke: "#61DAFB"
    style.border-radius: 12
    style.font-size: 20
  }

  ui: Router + 25 Features + Components {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/react/react-original.svg
    style.fill: "#16213e"
    style.stroke: "#61DAFB"
    style.border-radius: 12
    style.font-size: 20
  }

  # Internal
  cache -> server-state {
    style.stroke: "#FF4154"
    style.stroke-width: 2
    style.stroke-dash: 4
  }
  zustand -> ui-state {
    style.stroke: "#764ABC"
    style.stroke-width: 2
    style.stroke-dash: 4
  }
  hooks -> cache: updates {
    style.stroke: "#FF4154"
    style.stroke-width: 2
    style.stroke-dash: 4
  }
}

# ============================================
# CROSS-LAYER CONNECTIONS (ANIMATED)
# ============================================

# External -> Main
external.hub -> main.services: WebSocket {
  style.stroke: "#f59e0b"
  style.stroke-width: 4
  style.animated: true
  style.font-size: 16
}

external.anthropic -> main.services: SDK {
  style.stroke: "#D97706"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}

external.github -> main.services: REST {
  style.stroke: "#ffffff"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}

external.integrations -> main.services: OAuth2 {
  style.stroke: "#a855f7"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}

# Main -> Bridge
main.ipc -> bridge.invoke: ipcMain.handle {
  style.stroke: "#10b981"
  style.stroke-width: 4
  style.animated: true
  style.font-size: 16
}

main.services -> bridge.events: router.emit {
  style.stroke: "#22d3ee"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}

# Bridge -> Renderer
bridge.invoke -> renderer.hooks: IpcResult<T> {
  style.stroke: "#e94560"
  style.stroke-width: 4
  style.animated: true
  style.font-size: 16
}

bridge.events -> renderer.hooks: event data {
  style.stroke: "#22d3ee"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}

# Renderer -> Bridge (requests UP)
renderer.hooks -> bridge.invoke: invoke() {
  style.stroke: "#61DAFB"
  style.stroke-width: 3
  style.animated: true
  style.font-size: 16
}
