# Claude UI Architecture
# Bidirectional: Requests UP, Responses/Events DOWN

direction: down

vars: {
  d2-config: {
    theme-id: 200
    layout-engine: elk
  }
}

# ============================================
# LAYER 1: EXTERNAL APIs (Top - Most Abstract)
# ============================================
external: External APIs {
  style: {
    fill: "#1e1e30"
    stroke: "#f59e0b"
    stroke-width: 5
    border-radius: 20
    font-size: 40
    bold: true
  }

  hub: Hub Server {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/fastify/fastify-original.svg
    style.fill: "#16213e"
    style.stroke: "#f59e0b"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  anthropic: Anthropic {
    style.fill: "#16213e"
    style.stroke: "#D97706"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  github: GitHub {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg
    style.fill: "#16213e"
    style.stroke: "#ffffff"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  oauth: OAuth {
    style.fill: "#16213e"
    style.stroke: "#a855f7"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }
}

# ============================================
# LAYER 2: MAIN PROCESS (Electron Backend)
# ============================================
main: Main Process - Electron + Node.js {
  style: {
    fill: "#1a1a2e"
    stroke: "#10b981"
    stroke-width: 5
    border-radius: 20
    font-size: 40
    bold: true
  }

  services: "Services (28)" {
    style.fill: "#16213e"
    style.stroke: "#10b981"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  router: IPC Router {
    style.fill: "#16213e"
    style.stroke: "#f59e0b"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  storage: Local Files {
    style.fill: "#16213e"
    style.stroke: "#8b5cf6"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  # Internal: Router validates then calls Services
  router -> services: Zod + Handler {
    style.stroke: "#10b981"
    style.stroke-width: 3
    style.stroke-dash: 5
    style.font-size: 24
  }

  services -> storage {
    style.stroke: "#8b5cf6"
    style.stroke-width: 3
    style.stroke-dash: 5
  }
}

# ============================================
# LAYER 3: PRELOAD BRIDGE
# ============================================
bridge: Preload Bridge - window.api {
  style: {
    fill: "#0f3460"
    stroke: "#e94560"
    stroke-width: 5
    border-radius: 20
    font-size: 40
    bold: true
  }

  invoke: invoke() {
    style.fill: "#16213e"
    style.stroke: "#e94560"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  events: on() {
    style.fill: "#16213e"
    style.stroke: "#22d3ee"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }
}

# ============================================
# LAYER 4: RENDERER (React Frontend)
# ============================================
renderer: Renderer - React 19 {
  style: {
    fill: "#1a1a2e"
    stroke: "#4f46e5"
    stroke-width: 5
    border-radius: 20
    font-size: 40
    bold: true
  }

  query: React Query {
    style.fill: "#16213e"
    style.stroke: "#FF4154"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  zustand: Zustand {
    style.fill: "#16213e"
    style.stroke: "#764ABC"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  ui: Components {
    icon: https://cdn.jsdelivr.net/gh/devicons/devicon/icons/react/react-original.svg
    style.fill: "#16213e"
    style.stroke: "#61DAFB"
    style.stroke-width: 3
    style.border-radius: 12
    style.font-size: 32
  }

  # Internal renderer flow
  query -> ui {
    style.stroke: "#FF4154"
    style.stroke-width: 3
    style.stroke-dash: 5
  }
  zustand -> ui {
    style.stroke: "#764ABC"
    style.stroke-width: 3
    style.stroke-dash: 5
  }
}

# ============================================
# CONNECTIONS - Services call External APIs
# ============================================
external.hub -> main.services: WebSocket {
  style.stroke: "#f59e0b"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

external.anthropic -> main.services: SDK {
  style.stroke: "#D97706"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

external.github -> main.services: REST {
  style.stroke: "#ffffff"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

external.oauth -> main.services: Tokens {
  style.stroke: "#a855f7"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

# ============================================
# BIDIRECTIONAL IPC FLOW
# ============================================

# Requests: Bridge -> Router (UP)
bridge.invoke -> main.router: request {
  style.stroke: "#61DAFB"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

# Events: Services -> Bridge (DOWN)
main.services -> bridge.events: emit {
  style.stroke: "#22d3ee"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

# Requests: Renderer -> Bridge (UP)
renderer.query -> bridge.invoke: ipc() {
  style.stroke: "#61DAFB"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}

# Events: Bridge -> Renderer (DOWN)
bridge.events -> renderer.query: invalidate {
  style.stroke: "#22d3ee"
  style.stroke-width: 5
  style.animated: true
  style.font-size: 28
}
